name: PII Scan

on:
  pull_request:
    branches: [ "main", "develop" ]
  push:
    branches: [ "main" ]

jobs:
  scan:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: true

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.9"
        
    - name: Install Data Detector
      run: pip install .  # Installs from current source
      
    - name: Scan for PII
      run: |
        # Scan source code for PII patterns (informational only)
        # Note: This is a demo workflow. Source code legitimately contains PII
        # examples for testing/documentation, so we don't fail on matches.
        echo "Scanning source code for PII (informational)..."

        # Create a summary of any findings
        TOTAL_MATCHES=0

        find src -name "*.py" | while read file; do
          # Run scan and capture output
          OUTPUT=$(data-detector find --file "$file" --ns us --ns kr 2>/dev/null || true)

          # Check if matches were found
          if echo "$OUTPUT" | grep -q "Found [1-9]"; then
            echo "::notice file=$file::PII patterns found in $file"
            echo "$OUTPUT" | grep -E "^  " | head -5
          fi
        done

        echo "PII scan complete (informational only)"
